<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dashboard - Film Recommendation System</title>
	<link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="profile-container">
        <div class="profile-header">
            <h1>Dashboard</h1>
            <div class="nav-buttons">
                <a href="/profile">Profile</a>
                <a href="/logout">Logout</a>
            </div>
        </div>
        
        <div class="action-buttons">
            <form action="/recommendations" method="get">
                <button type="submit">Get Recommendations</button>
            </form>
            <form action="/films" method="get">
                <button type="submit">View Film List</button>
            </form>
        </div>

        <div class="genre-list">
            <h2>Genre Preferences</h2>
            <ul>
                <li><a href="/genres/action">Action</a></li>
                <li><a href="/genres/romance">Romance</a></li>
                <li><a href="/genres/sci-fi">Sci-Fi</a></li>
                <li><a href="/genres/comedy">Comedy</a></li>
            </ul>
        </div>
    </div>
	
	<form action="/search" method="get" class="search-form">
	    <input type="text" name="query" placeholder="Search by title, director, or genre" required>
	    <button type="submit">Search</button>
	</form>

	
	
	<div class="reviews-section">
	            <h2>Film Reviews</h2>
	            <div class="review-form">
	                <h3>Write a Review</h3>
	                <form id="reviewForm">
	                    <div class="form-group">
	                        <label for="filmSelect">Select Film</label>
	                        <select id="filmSelect" required>
	                            <option value="">Choose a film...</option>
	                            <option th:each="film : ${films}" th:value="${film.title}" th:text="${film.title}"></option>
	                        </select>
	                    </div>
	                    
	                    <div class="form-group">
	                        <label for="rating">Rating</label>
	                        <select id="rating" required>
	                            <option value="5">5 Stars</option>
	                            <option value="4">4 Stars</option>
	                            <option value="3">3 Stars</option>
	                            <option value="2">2 Stars</option>
	                            <option value="1">1 Star</option>
	                        </select>
	                    </div>

	                    <div class="form-group">
	                        <label for="reviewContent">Your Review</label>
	                        <textarea id="reviewContent" required placeholder="Write your review here..."></textarea>
	                    </div>

	                    <button type="submit" class="submit-review">Submit Review</button>
	                </form>
	            </div>

	            <div class="reviews-list" id="reviewsList">
	                <!-- Reviews will be loaded here dynamically -->
	            </div>
	        </div>
	    </div>

	    <script th:inline="javascript">
	        /*<![CDATA[*/
	        // Get the logged-in username from Thymeleaf
			const username = /*[[${user.username}]]*/ 'user';



	        document.addEventListener('DOMContentLoaded', function() {
	            const reviewForm = document.getElementById('reviewForm');
	            const filmSelect = document.getElementById('filmSelect');
	            
	            // Load reviews when a film is selected
	            filmSelect.addEventListener('change', loadReviews);
	            
	            // Handle review submission
	            reviewForm.addEventListener('submit', function(e) {
	                e.preventDefault();
	                submitReview();
	            });

	            // Initial load of reviews if a film is selected
	            if (filmSelect.value) {
	                loadReviews();
	            }
	        });

	        function loadReviews() {
	            const filmTitle = document.getElementById('filmSelect').value;
	            if (!filmTitle) return;

	            fetch(`/api/reviews/film/${encodeURIComponent(filmTitle)}`)
	                .then(response => response.json())
	                .then(reviews => {
	                    displayReviews(reviews);
	                })
	                .catch(error => {
	                    console.error('Error loading reviews:', error);
	                });
	        }

	        function displayReviews(reviews) {
	            const reviewsList = document.getElementById('reviewsList');
	            reviewsList.innerHTML = '';

	            reviews.forEach(review => {
	                const reviewElement = document.createElement('div');
	                reviewElement.className = 'review-item';
	                reviewElement.innerHTML = `
	                    <div class="review-header">
	                        <strong>${review.username}</strong>
	                        <span class="review-rating">${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}</span>
	                    </div>
	                    <div class="review-content">${review.content}</div>
	                    <div class="review-meta">Posted on ${new Date(review.createdAt).toLocaleDateString()}</div>
	                `;
	                reviewsList.appendChild(reviewElement);
	            });
	        }

	        function submitReview() {
	            const review = {
	                username: username,
	                filmTitle: document.getElementById('filmSelect').value,
	                content: document.getElementById('reviewContent').value,
	                rating: parseInt(document.getElementById('rating').value)
	            };

	            fetch('/api/reviews', {
	                method: 'POST',
	                headers: {
	                    'Content-Type': 'application/json',
	                },
	                body: JSON.stringify(review)
	            })
	            .then(response => {
	                if (response.ok) {
	                    alert('Review submitted successfully!');
	                    document.getElementById('reviewForm').reset();
	                    loadReviews();
	                } else {
	                    throw new Error('Failed to submit review');
	                }
	            })
	            .catch(error => {
	                console.error('Error:', error);
	                alert('Error submitting review. Please try again.');
	            });
	        }
	       
	    </script>
		/*]]>*/
		
</body>
</html>
